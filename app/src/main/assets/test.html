<!DOCTYPE html>
<html>
<head lang="zh-cmn-Hans">
    <meta charset="UTF-8">
    <title>DWebviewJavaScriptdsBridge Test</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=0.5,user-scalable=no"/>
</head>
<style>
        .btn {
            text-align: center;
            background: dodgerblue;
            color: white;
            padding: 20px;
            margin: 30px;
            font-size: 24px;
            border-radius: 4px;
            box-shadow: 4px 2px 10px #999;
        }

    .btn:active {
        opacity: .7;
        box-shadow: 4px 2px 10px #555;
    }

        </style>
<body>
<div class="btn" onclick="callSync()">call sync</div>
<div class="btn" onclick="callAsync()">call async</div>
<div class="btn" onclick="callNoArgSync()">no arg call sync</div>
<div class="btn" onclick="callNoArgAsync()">no arg call async</div>
<div class="btn" onclick="callNever()">call unexist handler</div>
<div class="btn" onclick="callProgress()">call progress <span id='progress'></span></div>
<div class="btn" onclick="alert(confirm('Press a button'))">confirm test</div>
<div class="btn" onclick="alert(prompt('Please input user name.','hello, world'))">prompt test</div>

<script>
/* BRIDGE BEGIN */
function getJsBridge(bridgeName) {
  var internalBridgeName = bridgeName || '_dsbridge';
  var internalBridge = window[internalBridgeName];
  if (!internalBridge) {
    throw new Error('No injected global bridge object.');
  }

  var counter = 0;
  var jsBridge = {
    callbackMap: {},
    handlerMap: {},
    callHandler: function (name, args, callback) {
      var ret = '';
      if (typeof args == 'function') {
        callback = args;
        args = {};
      }
      if (typeof callback == 'function') {
        var callbackId = counter++;
        this.callbackMap[callbackId] = callback;
        args['_callbackId'] = callbackId;
      }
      args = JSON.stringify(args || {});
      console.log('===callHandler', name, args, callback);

      // WKWebview
      if (internalBridge.wk) {
        ret = prompt(internalBridgeName + '=' + name, args);
      } else {
        ret = internalBridge.callHandler(name, args);
      }
      return ret;
    },
    registerHandler: function (name, handler) {
      console.log('===registerHandler' + name);
      this.handlerMap[name] = handler;
    },
  };

  // extend internal bridge
  internalBridge.invokeHandler = function (name, args, callbackId) {
    console.log('===invokeHandler', name, args);
    var handler = jsBridge.handlerMap[name];
    if (handler.length === 2) {
      // async handler
      handler(args, function (ret) {
        if (typeof callbackId === 'undefined') return;
        if (internalBridge.wk) {
          prompt(internalBridgeName + 'cid=' + callbackId, JSON.stringify(ret));
        } else {
          internalBridge.returnValue(callbackId, JSON.stringify(ret));
        }
      });
    } else {
      internalBridge.returnValue(callbackId, JSON.stringify(handler(args)));
    }
  };
  internalBridge.invokeCallback = function (callbackId, result, complete) {
    console.log('===invokeCallback' + complete);
    console.log(callbackId);
    console.log(result);
    console.log(typeof complete);
    var callback = jsBridge.callbackMap[callbackId];
    if (complete) {
      delete jsBridge.callbackMap[callbackId];
    }
    callback(result);
  };

  return jsBridge;
}
/* BRIDGE END */

// bridge demo

var bridge = getJsBridge();
console.log(bridge);

function callSync() {
  alert(bridge.callHandler('testSync', { msg: 'testSync' }));
}

function callAsync() {
  alert(bridge.callHandler('testAsync', { msg: 'testAsync' }, function (ret) {
    if (ret.error) {
      console.error(ret.error);
      return;
    }
    alert(ret.result);
  }));
}

function callNoArgSync() {
  alert(bridge.callHandler('testNoArgSync'));
}

function callNoArgAsync() {
  bridge.callHandler('testNoArgAsync', function (ret) {
    if (ret.error) {
      console.error(ret.error);
      return;
    }
    alert(ret.result);
  });
}

function callNever() {
  bridge.callHandler('testNever', { msg: 'testNever' });
}

function callProgress(){
  bridge.callHandler('callProgress', function (ret) {
    if (ret.error) {
      console.error(ret.error);
      return;
    }
    document.getElementById('progress').innerText = ret.result;
  });
}

// sync handler
bridge.registerHandler('addValue', function (args) {
  return args[0] + args[1];
});

// async handler
bridge.registerHandler('addValueAsync', function (args, callback) {
  callback(args[0] + args[1]);
});
</script>
</body>
</html>
